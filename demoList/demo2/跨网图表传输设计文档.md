# 跨网图表传输方案（简单版）

## 核心流程

```
红区                               黄区
┌──────────────┐                 ┌──────────────┐
│              │                 │              │
│ 1. 生成图表  │                 │              │
│ 2. 截图PNG   │                 │              │
│ 3. 写元数据  │                 │              │
│ 4. 打包ZIP   │────传输──────▶  │ 5. 接收ZIP   │
│              │                 │ 6. 解压      │
└──────────────┘                 │ 7. 读元数据  │
                                 │ 8. 上传OSS    │
                                 │ 9. 入库       │
                                 └──────────────┘
                                      │
                                      ▼
                                 ┌─────────┐
                                 │ 前端显示│
                                 └─────────┘
```

---

## 1. ZIP文件结构

```
report-{tool}-{reportId}-{timestamp}.zip
├── meta.json          # 必须：报告元数据（黄区入库需要）
├── charts/            # 图表图片
│   ├── overview.png   # 概览图
│   ├── scatter.png    # 散点图
│   └── trend.png      # 趋势图
└── data/              # 原始数据（可选，用于下载）
    └── raw-data.csv
```

---

## 2. meta.json 结构（核心）

```json
{
  "tool": "performance-test-platform",
  "version": "2.1.0",
  "reportId": "RPT20250122153045",
  "title": "性能测试报告 - 场景A",
  "description": "10万并发下的性能测试结果",
  "category": "performance",

  "createdAt": "2025-01-22T15:30:45+08:00",
  "createdBy": "zhangsan",
  "source": "红区测试平台",

  "charts": [
    {
      "id": "overview",
      "title": "测试概览",
      "file": "charts/overview.png",
      "description": "整体测试情况汇总",
      "type": "summary"
    },
    {
      "id": "scatter",
      "title": "响应时间分布",
      "file": "charts/scatter.png",
      "description": "10万次请求的响应时间散点图",
      "type": "data-visualization"
    },
    {
      "id": "trend",
      "title": "吞吐量趋势",
      "file": "charts/trend.png",
      "description": "每秒吞吐量变化趋势",
      "type": "time-series"
    }
  ],

  "dataFiles": [
    {
      "file": "data/raw-data.csv",
      "description": "原始测试数据，可用于离线分析",
      "size": 1024000,
      "format": "csv"
    }
  ],

  "tags": ["性能测试", "高并发", "压测"],
  "metadata": {
    "testDuration": "10分钟",
    "totalRequests": 100000,
    "successRate": "99.9%",
    "avgResponseTime": "123ms"
  }
}
```

---

## 3. 关键字段说明

### 3.1 黄区入库必须字段

| 字段 | 说明 | 示例 |
|------|------|------|
| **tool** | 生成工具/系统名称 | `"performance-test-platform"` |
| **version** | 工具版本 | `"2.1.0"` |
| **category** | 报告分类 | `"performance"` / `"functional"` / `"security"` |
| **reportId** | 报告唯一ID | `"RPT20250122153045"` |
| **title** | 报告标题 | `"性能测试报告 - 场景A"` |

### 3.2 黄区展示需要字段

| 字段 | 说明 |
|------|------|
| **charts[]** | 图表列表（图片路径+描述） |
| **charts[].id** | 图表唯一标识 |
| **charts[].title** | 图表标题 |
| **charts[].file** | ZIP内图片路径 |
| **charts[].type** | 图表类型（用于分类展示） |

### 3.3 可选扩展字段

| 字段 | 说明 |
|------|------|
| **tags** | 标签（用于检索和分类） |
| **metadata** | 业务自定义元数据 |
| **dataFiles** | 原始数据文件（用于下载） |

---

## 4. 数据库设计

```sql
CREATE TABLE report (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    report_id VARCHAR(64) UNIQUE NOT NULL COMMENT '报告ID',

    -- 来源信息（必须）
    tool VARCHAR(100) NOT NULL COMMENT '生成工具',
    version VARCHAR(50) COMMENT '工具版本',
    category VARCHAR(50) COMMENT '报告分类',

    -- 基本信息
    title VARCHAR(200) NOT NULL COMMENT '报告标题',
    description TEXT COMMENT '报告描述',

    -- 元数据
    meta JSON NOT NULL COMMENT '完整的meta.json内容',

    -- 文件存储
    file_prefix VARCHAR(200) NOT NULL COMMENT 'OSS路径前缀',

    -- 时间和用户
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100) COMMENT '创建人',

    INDEX idx_report_id (report_id),
    INDEX idx_tool (tool),
    INDEX idx_category (category),
    INDEX idx_created_at (created_at)
) COMMENT '报告表';
```

---

## 5. 黄区入库处理逻辑

```java
@PostMapping("/receive-report")
public ApiResponse receiveReport(@RequestParam MultipartFile zipFile) {
    // 1. 解压ZIP到临时目录
    Path tempDir = unzip(zipFile);

    // 2. 读取并解析 meta.json
    JsonObject meta = readJson(tempDir.resolve("meta.json"));

    // 3. 验证必须字段
    validateMeta(meta); // 检查 tool, version, reportId 等

    // 4. 生成存储路径
    String filePrefix = generatePath(
        meta.getString("tool"),      // performance-test-platform
        meta.getString("reportId")   // RPT20250122153045
    );
    // 结果: performance-test-platform/RPT20250122153045/

    // 5. 上传所有文件到OSS
    uploadToOSS(tempDir, filePrefix);

    // 6. 入库
    Report report = new Report();
    report.setReportId(meta.getString("reportId"));
    report.setTool(meta.getString("tool"));
    report.setVersion(meta.getString("version"));
    report.setCategory(meta.getString("category"));
    report.setTitle(meta.getString("title"));
    report.setMeta(meta); // 存储完整的meta.json
    report.setFilePrefix(filePrefix);
    repository.save(report);

    // 7. 清理临时文件
    cleanTempDir(tempDir);

    return ApiResponse.success(report.getId());
}
```

---

## 6. OSS存储结构

```
oss-bucket/
└── reports/
    └── performance-test-platform/          # 按 tool 分类
        └── RPT20250122153045/              # 按 reportId 分目录
            ├── meta.json
            ├── charts/
            │   ├── overview.png
            │   ├── scatter.png
            │   └── trend.png
            └── data/
                └── raw-data.csv
```

**访问URL格式**：
```
https://oss.example.com/reports/performance-test-platform/RPT20250122153045/charts/overview.png
```

---

## 7. API设计

### 7.1 黄区：接收报告

```
POST /api/yellow/receive-report
Content-Type: multipart/form-data

file: <ZIP文件>
```

**响应**：
```json
{
  "code": 200,
  "message": "接收成功",
  "data": {
    "reportId": "RPT20250122153045",
    "id": 123456
  }
}
```

### 7.2 黄区：查询报告列表

```
GET /api/yellow/reports?tool=performance-test-platform&page=0&size=20
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "total": 100,
    "items": [
      {
        "reportId": "RPT20250122153045",
        "tool": "performance-test-platform",
        "version": "2.1.0",
        "category": "performance",
        "title": "性能测试报告 - 场景A",
        "createdAt": "2025-01-22T15:30:45"
      }
    ]
  }
}
```

### 7.3 黄区：获取报告详情

```
GET /api/yellow/report/{reportId}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "reportId": "RPT20250122153045",
    "tool": "performance-test-platform",
    "title": "性能测试报告 - 场景A",
    "meta": {...},                              // 完整的meta.json
    "charts": [                                 // 图表列表（从meta解析）
      {
        "id": "overview",
        "title": "测试概览",
        "url": "https://oss.example.com/reports/.../overview.png",
        "description": "整体测试情况汇总"
      }
    ],
    "fileBaseUrl": "https://oss.example.com/reports/performance-test-platform/RPT20250122153045/"
  }
}
```

### 7.4 黄区：获取图片

```
GET /api/yellow/report/{reportId}/chart/{chartId}
```

**说明**：重定向到OSS图片地址

---

## 8. 前端展示逻辑

```javascript
// 1. 获取报告详情
const report = await api.getReport('/api/yellow/report/RPT20250122153045');

// 2. 显示标题
document.title = report.title;

// 3. 遍历图表并显示
report.charts.forEach(chart => {
  const img = document.createElement('img');
  img.src = chart.url;
  img.alt = chart.title;
  container.appendChild(img);
});

// 4. 显示元数据
document.getElementById('metadata').textContent =
  `工具: ${report.tool} ${report.version}\n` +
  `创建时间: ${report.meta.createdAt}\n` +
  `创建人: ${report.meta.createdBy}`;
```

---

## 9. reportId 生成规则

```
格式: RPT{yyyyMMddHHmmss}{随机4位}
示例: RPT20250122153045AB12
```

---

## 10. OSS路径生成规则

```
格式: {tool}/{reportId}/
示例: performance-test-platform/RPT20250122153045/
```

---

## 11. 黄区入库后能做什么

入库完成后，黄区可以根据 `tool` 和 `category` 做不同处理：

### 示例1：按工具分类展示
```java
if ("performance-test-platform".equals(report.getTool())) {
    // 显示性能测试报告的专用UI
}
```

### 示例2：按分类路由
```java
switch (report.getCategory()) {
    case "performance":
        return renderPerformanceReport(report);
    case "functional":
        return renderFunctionalReport(report);
    case "security":
        return renderSecurityReport(report);
}
```

### 示例3：版本兼容
```java
if (compareVersion(report.getVersion(), "2.0.0") >= 0) {
    // 使用新版UI
} else {
    // 兼容旧版UI
}
```

---

## 12. 实施步骤

### 第1步：定义meta.json规范（1天）
- [ ] 确定必须字段（tool、version、category等）
- [ ] 确定可选字段（tags、metadata等）
- [ ] 编写规范文档

### 第2步：红区实现打包逻辑（2天）
- [ ] 生成图表截图
- [ ] 生成meta.json
- [ ] 打包ZIP
- [ ] 传输到黄区

### 第3步：黄区实现接收存储（2天）
- [ ] 接收ZIP
- [ ] 解压并验证meta.json
- [ ] 上传OSS
- [ ] 入库

### 第4步：前端展示（1天）
- [ ] 查询报告列表
- [ ] 显示报告详情
- [ ] 展示图表图片

**总计：约1周**

---

## 13. 关键配置

```yaml
# application.yml
report:
  # 黄区配置
  yellow:
    temp-dir: /tmp/report-zips
    oss:
      endpoint: http://minio:9000
      bucket: report-data
      path-prefix: reports/
```

---

## 14. 常见问题

**Q: 不同工具生成的meta.json字段不一样怎么办？**
A: 必须字段统一（tool、version、reportId等），其他字段可以自定义，存在meta JSON字段中。

**Q: 同一个reportId重复传输怎么办？**
A: 可以做update操作，覆盖原有文件；或者拒绝，返回错误。

**Q: 图片太多怎么办？**
A: meta.json中可以设置默认显示的图表，其他的折叠显示。

**Q: 需要支持交互式图表怎么办？**
A: 在meta.json中添加交互配置字段，前端根据配置加载对应的库渲染。

---

**版本**：v4.0（图片版，简单实用）
**核心思想**：红区生成图片+元数据，黄区存储展示，简单清晰
