# 推送功能模块设计文档

## 1. 项目概述

本项目实现一个可配置的多平台推送管理模块，支持对接不同平台的API进行推送，并提供配置化、历史记录和群组管理功能。

## 2. 技术栈

| 层级 | 技术选型 |
|------|---------|
| 前端 | Vue 3 + Element UI Plus + JavaScript |
| 后端 | Java 21 + Spring Boot 3.4.4 |
| 数据库 | MySQL 8.0+ |

## 3. 架构设计原则

- **简洁性**：避免过度设计，用最简单的方案满足需求
- **扩展性**：通过抽象接口支持新增推送平台
- **配置化**：核心参数通过配置管理，减少硬编码
- **可追溯**：所有推送操作留痕

## 4. 数据库设计

### 4.1 推送平台表 (`push_platform`)
存储支持的推送平台信息

```sql
CREATE TABLE push_platform (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    platform_code VARCHAR(50) NOT NULL UNIQUE COMMENT '平台编码：W3_TODO, WELINK_APP',
    platform_name VARCHAR(100) NOT NULL COMMENT '平台名称',
    api_endpoint VARCHAR(255) COMMENT 'API地址（可选，配置中覆盖）',
    enabled TINYINT DEFAULT 1 COMMENT '是否启用 0-禁用 1-启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推送平台表';
```

### 4.2 业务类型表 (`business_type`)
存储业务类型信息

```sql
CREATE TABLE business_type (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    business_code VARCHAR(50) NOT NULL UNIQUE COMMENT '业务编码：QA_REPORT, TEST_REPORT',
    business_name VARCHAR(100) NOT NULL COMMENT '业务名称',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='业务类型表';
```

### 4.3 推送配置表 (`push_config`)
业务类型与推送平台的配置关系

```sql
CREATE TABLE push_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    business_type_id BIGINT NOT NULL COMMENT '业务类型ID',
    platform_code VARCHAR(50) NOT NULL COMMENT '平台编码',
    enabled TINYINT DEFAULT 1 COMMENT '是否启用',
    config_json TEXT COMMENT '推送配置JSON（静态参数）',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_business_platform (business_type_id, platform_code),
    FOREIGN KEY (business_type_id) REFERENCES business_type(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推送配置表';
```

### 4.4 推送历史表 (`push_history`)
所有推送记录

```sql
CREATE TABLE push_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    business_type_id BIGINT NOT NULL COMMENT '业务类型ID',
    platform_code VARCHAR(50) NOT NULL COMMENT '平台编码',
    group_id BIGINT COMMENT '使用的群组ID',
    business_key VARCHAR(100) COMMENT '业务主键（如报告ID）',
    request_json TEXT NOT NULL COMMENT '完整请求参数',
    response_json TEXT COMMENT '响应结果',
    status TINYINT DEFAULT 0 COMMENT '状态 0-失败 1-成功',
    error_message TEXT COMMENT '错误信息',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_business_type (business_type_id),
    INDEX idx_platform (platform_code),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推送历史表';
```

### 4.5 推送群组表 (`push_group`)
推送群组信息

```sql
CREATE TABLE push_group (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    group_name VARCHAR(100) NOT NULL COMMENT '群组名称',
    description VARCHAR(255) COMMENT '群组描述',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推送群组表';
```

### 4.6 群组成员表 (`group_member`)
群组成员关系

```sql
CREATE TABLE group_member (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    group_id BIGINT NOT NULL COMMENT '群组ID',
    employee_no VARCHAR(50) NOT NULL COMMENT '工号',
    employee_name VARCHAR(100) COMMENT '姓名',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_group_employee (group_id, employee_no),
    FOREIGN KEY (group_id) REFERENCES push_group(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群组成员表';
```

## 5. 后端设计

### 5.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                      Controller 层                        │
│  - PushConfigController                                   │
│  - PushHistoryController                                  │
│  - PushGroupController                                    │
│  - PushController (推送执行)                               │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                      Service 层                           │
│  - PushConfigService                                      │
│  - PushHistoryService                                     │
│  - PushGroupService                                       │
│  - PushService (推送编排)                                  │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                      推送适配器层                          │
│  - PushPlatformStrategy (接口)                            │
│  - W3TodoPushStrategy (W3代办实现-模拟)                    │
│  - WeLinkAppPushStrategy (WeLink应用号实现-模拟)               │
└─────────────────────────────────────────────────────────┘
```

### 5.2 核心接口设计

#### 5.2.1 推送配置接口

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/push/config/business/{businessCode} | 获取业务配置 |
| POST | /api/push/config | 保存/更新推送配置 |
| DELETE | /api/push/config/{id} | 删除配置 |
| GET | /api/push/config/business-types | 获取所有业务类型 |

#### 5.2.2 推送接口

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/push/preview | 预览推送内容 |
| POST | /api/push/execute | 执行推送 |

#### 5.2.3 历史记录接口

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/push/history/page | 分页查询历史记录 |
| GET | /api/push/history/{id} | 获取详情 |

#### 5.2.4 群组接口

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/push/groups | 获取群组列表 |
| POST | /api/push/groups | 创建群组 |
| PUT | /api/push/groups/{id} | 更新群组 |
| DELETE | /api/push/groups/{id} | 删除群组 |
| GET | /api/push/groups/{id}/members | 获取群组成员 |
| POST | /api/push/groups/{id}/members | 添加成员 |
| DELETE | /api/push/groups/{id}/members/{memberId} | 删除成员 |

### 5.3 推送策略接口

```java
public interface PushPlatformStrategy {
    /**
     * 构建推送参数
     */
    Map<String, Object> buildPushRequest(
        Map<String, Object> config,
        Map<String, Object> dynamicParams,
        List<GroupMember> groupMembers
    );

    /**
     * 执行推送（当前为模拟实现）
     */
    PushResult execute(Map<String, Object> request);

    /**
     * 获取平台编码
     */
    String getPlatformCode();
}
```

## 6. 前端设计

### 6.1 目录结构

```
src/
├── api/
│   ├── request.js       # Axios 封装（含拦截器）
│   ├── push.js          # 推送相关API（preview/execute）
│   ├── config.js        # 配置相关API
│   ├── history.js       # 历史记录API
│   └── group.js         # 群组相关API
├── components/
│   ├── PushDialog.vue                # 推送预览&执行弹窗（核心组件）
│   ├── PushHistoryDialog.vue         # 历史记录查询弹窗
│   ├── GroupConfigDialog.vue         # 群组&成员配置弹窗
│   └── BusinessTypeConfigDialog.vue  # 业务类型&推送配置弹窗
├── App.vue            # 主应用（包含演示页面）
└── main.js            # 应用入口
```

### 6.2 核心组件设计

#### 6.2.1 PushDialog.vue - 推送预览&执行弹窗（公共组件）

这是**最重要的公共组件**，供业务系统调用来执行推送操作。

**功能特性：**
- 显示业务类型和已配置的推送平台
- 实时预览每个平台的完整推送参数
- 群组选择（切换群组自动刷新预览）
- 格式化展示参数值（支持数组、对象、字符串）
- 二次确认机制防止误操作
- 快捷入口：历史记录、群组配置、业务类型配置

**Props 参数：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `visible` | Boolean | 是 | 控制弹窗显示/隐藏（支持 v-model） |
| `businessCode` | String | 是 | 业务编码（如：QA_REPORT） |
| `dynamicParams` | Object | 是 | 动态参数（如：{title, content, jumpUrl}） |
| `businessKey` | String | 否 | 业务主键（用于记录关联，如报告ID） |

**Events 事件：**

| 事件名 | 参数 | 说明 |
|--------|------|------|
| `update:visible` | Boolean | 弹窗显示状态变化 |
| `success` | - | 推送成功后触发（可用于刷新列表等） |

**调用示例：**

```vue
<template>
  <div>
    <!-- 触发按钮 -->
    <el-button @click="showPushDialog">推送报告</el-button>

    <!-- 推送弹窗组件 -->
    <PushDialog
      v-model:visible="pushDialogVisible"
      business-code="QA_REPORT"
      :dynamic-params="pushParams"
      business-key="report-123"
      @success="handlePushSuccess"
    />
  </div>
</template>

<script setup>
import { ref } from 'vue'
import PushDialog from '@/components/PushDialog.vue'

const pushDialogVisible = ref(false)
const pushParams = ref({
  title: 'QA周报 - 第42周',
  content: '本周QA报告已生成，请查阅',
  jumpUrl: 'https://example.com/report/123'
})

const showPushDialog = () => {
  pushDialogVisible.value = true
}

const handlePushSuccess = () => {
  console.log('推送成功')
  // 可在此处执行后续操作，如刷新列表、更新状态等
}
</script>
```

**数据流程：**
1. 组件打开时自动加载群组列表和推送预览
2. 用户选择群组后，自动刷新预览（包含群组成员信息）
3. 点击"确定推送"后，弹出确认框
4. 确认后调用 execute 接口执行推送
5. 所有平台的推送结果记录到历史表

**UI 展示：**
```
┌─────────────────────────────────────────────────┐
│ 推送预览              [历史记录] [群组配置] [配置] │
├─────────────────────────────────────────────────┤
│ 业务类型: QA报告                                  │
├─────────────────────────────────────────────────┤
│ ┌─ W3代办 (W3_TODO) ─────────────────────────┐ │
│ │ 群组: [QA审核组 ▼]                          │ │
│ │ ──────────────────────────────────────────  │ │
│ │ 标题:     QA周报 - 第42周                    │ │
│ │ 内容:     本周QA报告已生成，请查阅            │ │
│ │ 跳转链接: https://example.com/report/123     │ │
│ │ 接收人:   c00807372(张三), c00807373(李四)   │ │
│ │ 类型:     QA                                │ │
│ │ 来源:     QA系统                            │ │
│ └────────────────────────────────────────────┘ │
│                                                  │
│ ┌─ WeLink应用号 (WELINK_APP) ─────────────────┐ │
│ │ ...类似结构...                               │ │
│ └────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────┤
│                            [取消] [确定推送]      │
└─────────────────────────────────────────────────┘
```

#### 6.2.2 PushHistoryDialog.vue - 历史记录查询弹窗

**功能特性：**
- 表格展示历史推送记录
- 支持分页查询
- 显示业务、平台、群组、状态、时间
- 可查看详情（完整请求参数和响应结果）

**Props 参数：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `visible` | Boolean | 是 | 控制弹窗显示/隐藏（支持 v-model） |

**调用示例：**
```vue
<PushHistoryDialog v-model:visible="historyVisible" />
```

#### 6.2.3 GroupConfigDialog.vue - 群组&成员配置弹窗

**功能特性：**
- 群组 CRUD（创建、编辑、删除）
- 成员管理（添加/删除成员）
- 支持工号输入添加
- 成员列表展示

**Props 参数：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `visible` | Boolean | 是 | 控制弹窗显示/隐藏（支持 v-model） |

**调用示例：**
```vue
<GroupConfigDialog v-model:visible="groupConfigVisible" />
```

#### 6.2.4 BusinessTypeConfigDialog.vue - 业务类型&推送配置弹窗

**功能特性：**
- 左右分栏布局：左侧业务类型列表，右侧推送平台配置
- 业务类型 CRUD
- 推送平台配置 CRUD
- 启用/禁用开关（即时生效）
- JSON 配置编辑器

**Props 参数：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `visible` | Boolean | 是 | 控制弹窗显示/隐藏（支持 v-model） |

**调用示例：**
```vue
<BusinessTypeConfigDialog v-model:visible="configVisible" />
```

### 6.3 API 封装说明

#### 6.3.1 Axios 拦截器（api/request.js）

```javascript
// 请求拦截器：添加 token 等认证信息（如需要）
// 响应拦截器：统一处理 ApiResponse 结构
axios.interceptors.response.use(
  response => {
    // 后端返回 { code: 200, message: "", data: {} }
    if (response.data.code === 200) {
      return response.data  // 直接返回 data
    }
    return Promise.reject(response.data)
  },
  error => {
    return Promise.reject(error)
  }
)
```

#### 6.3.2 核心 API 方法

```javascript
// push.js - 推送相关
pushApi.preview({ businessCode, dynamicParams, groupId })  // 预览推送
pushApi.execute({ businessCode, groupId, dynamicParams, businessKey })  // 执行推送
pushApi.getPlatforms()  // 获取所有推送平台

// group.js - 群组相关
groupApi.getAll()  // 获取所有群组
groupApi.create(data)  // 创建群组
groupApi.update(id, data)  // 更新群组
groupApi.delete(id)  // 删除群组
groupApi.getMembers(groupId)  // 获取群组成员
groupApi.addMember(groupId, data)  // 添加成员
groupApi.deleteMember(memberId)  // 删除成员

// config.js - 配置相关
configApi.getBusinessTypes()  // 获取所有业务类型
configApi.getBusinessConfig(businessCode)  // 获取业务的推送配置
configApi.saveConfig(data)  // 保存推送配置
configApi.deleteConfig(id)  // 删除推送配置

// history.js - 历史记录
historyApi.getPage(page, size)  // 分页查询历史
historyApi.getDetail(id)  // 获取详情
```

### 6.4 完整业务集成示例

假设有一个 QA 报告系统，需要在报告生成后推送通知：

```vue
<template>
  <div class="qa-report-page">
    <h1>QA 报告列表</h1>

    <el-table :data="reports">
      <el-table-column prop="id" label="报告ID" />
      <el-table-column prop="title" label="报告标题" />
      <el-table-column prop="status" label="状态" />
      <el-table-column label="操作" width="200">
        <template #default="{ row }">
          <el-button size="small" @click="viewReport(row)">查看</el-button>
          <el-button size="small" type="primary" @click="showPushDialog(row)">
            推送
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 推送弹窗 -->
    <PushDialog
      v-model:visible="pushDialogVisible"
      business-code="QA_REPORT"
      :dynamic-params="currentPushParams"
      :business-key="currentReportId"
      @success="handlePushSuccess"
    />

    <!-- 快捷入口弹窗（可选，放在页面右上角或设置中） -->
    <PushHistoryDialog v-model:visible="historyVisible" />
    <GroupConfigDialog v-model:visible="groupConfigVisible" />
    <BusinessTypeConfigDialog v-model:visible="configVisible" />
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { ElMessage } from 'element-plus'
import PushDialog from '@/components/PushDialog.vue'
import PushHistoryDialog from '@/components/PushHistoryDialog.vue'
import GroupConfigDialog from '@/components/GroupConfigDialog.vue'
import BusinessTypeConfigDialog from '@/components/BusinessTypeConfigDialog.vue'

// 报告数据
const reports = ref([
  { id: 'report-001', title: 'QA周报-第42周', status: '已生成' },
  { id: 'report-002', title: 'QA月报-10月', status: '已生成' }
])

// 推送弹窗控制
const pushDialogVisible = ref(false)
const currentReport = ref(null)
const currentReportId = computed(() => currentReport.value?.id || '')
const currentPushParams = computed(() => ({
  title: currentReport.value?.title || '',
  content: `您的${currentReport.value?.title}已生成，请查阅`,
  jumpUrl: `https://example.com/qa/report/${currentReport.value?.id}`
}))

// 快捷入口弹窗控制
const historyVisible = ref(false)
const groupConfigVisible = ref(false)
const configVisible = ref(false)

// 显示推送弹窗
const showPushDialog = (report) => {
  currentReport.value = report
  pushDialogVisible.value = true
}

// 推送成功回调
const handlePushSuccess = () => {
  ElMessage.success('推送成功')
  // 可选：刷新报告列表、更新推送状态等
}

// 查看报告
const viewReport = (report) => {
  console.log('查看报告:', report)
}
</script>
```

### 6.5 参数说明

#### 6.5.1 业务编码（businessCode）

用于标识不同的业务场景，需在数据库 `business_type` 表中预先配置：

| 业务编码 | 业务名称 | 说明 |
|----------|----------|------|
| QA_REPORT | QA报告 | QA相关报告推送 |
| TEST_REPORT | 测试报告 | 测试报告推送 |
| ... | ... | 按需扩展 |

#### 6.5.2 动态参数（dynamicParams）

推送时传递的动态参数，会与配置中的静态参数合并：

```javascript
{
  title: '报告标题',           // 推送标题
  content: '报告内容摘要',      // 推送内容
  jumpUrl: 'https://...'      // 跳转链接（可选）
}
```

具体参数结构由各推送平台的 strategy 决定。

#### 6.5.3 业务主键（businessKey）

用于关联业务数据，记录到历史表中方便追溯：

```javascript
businessKey: 'report-123'  // 或其他业务唯一标识
```

## 7. Spring Boot 配置

```yaml
server:
  port: 8080

spring:
  application:
    name: push-system

  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/push_system?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&createDatabaseIfNotExist=true
    username: root
    password: chd19970227

  jpa:
    hibernate:
      ddl-auto: none
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        format_sql: true
```

## 8. 初始化数据

```sql
-- 初始化推送平台
INSERT INTO push_platform (platform_code, platform_name) VALUES
('W3_TODO', 'W3代办'),
('WELINK_APP', 'WeLink应用号');

-- 初始化业务类型
INSERT INTO business_type (business_code, business_name) VALUES
('QA_REPORT', 'QA报告'),
('TEST_REPORT', '测试报告');

-- 初始化推送配置示例
INSERT INTO push_config (business_type_id, platform_code, enabled, config_json) VALUES
(1, 'W3_TODO', 1, '{"type": "QA", "source": "QA系统"}'),
(2, 'W3_TODO', 1, '{"type": "Test", "source": "测试系统"}'),
(2, 'WELINK_APP', 1, '{"category": "test_report"}');

-- 初始化测试群组
INSERT INTO push_group (group_name, description) VALUES
('QA审核组', 'QA报告审核人员'),
('测试组', '测试相关人员');

-- 初始化群组成员
INSERT INTO group_member (group_id, employee_no, employee_name) VALUES
(1, 'c00807372', '张三'),
(1, 'c00807373', '李四'),
(2, 'c00807374', '王五'),
(2, 'c00807375', '赵六');
```

## 9. 运行说明

### 9.1 后端运行

```bash
cd push-backend
mvn clean spring-boot:run
```

后端服务将运行在 `http://localhost:8080`

### 9.2 前端运行

```bash
cd push-frontend
npm run dev
```

前端服务将运行在 `http://localhost:5173`

## 10. 推送实现说明

当前推送策略采用**模拟实现**，不实际调用外部 API：

- `W3TodoPushStrategy`: 模拟 W3 代办推送，打印请求参数到控制台
- `WeLinkAppPushStrategy`: 模拟 WeLink 应用号推送，打印请求参数到控制台

**后续集成真实 API：**

1. 在 `pom.xml` 添加 OpenFeign 依赖（如需要）
2. 创建 Feign Client 接口
3. 在策略实现中注入并调用
4. 删除模拟代码

示例代码已包含注释说明集成位置。

## 11. 文件清单

### 后端文件

```
push-backend/src/main/java/com/push/
├── PushApplication.java           # 启动类
├── controller/
│   ├── PushConfigController.java
│   ├── PushController.java
│   ├── PushHistoryController.java
│   └── PushGroupController.java
├── service/
│   ├── impl/
│   │   ├── PushConfigServiceImpl.java
│   │   ├── PushServiceImpl.java
│   │   ├── PushHistoryServiceImpl.java
│   │   └── PushGroupServiceImpl.java
│   ├── PushConfigService.java
│   ├── PushService.java
│   ├── PushHistoryService.java
│   └── PushGroupService.java
├── strategy/
│   ├── PushPlatformStrategy.java
│   ├── W3TodoPushStrategy.java
│   └── WeLinkAppPushStrategy.java
├── entity/
│   ├── PushPlatform.java
│   ├── BusinessType.java
│   ├── PushConfig.java
│   ├── PushHistory.java
│   ├── PushGroup.java
│   └── GroupMember.java
├── dto/
│   ├── PushPreviewRequest.java
│   ├── PushPreviewResponse.java
│   ├── PushExecuteRequest.java
│   ├── PushResult.java
│   └── ApiResponse.java
├── mapper/
│   ├── PushPlatformRepository.java
│   ├── BusinessTypeRepository.java
│   ├── PushConfigRepository.java
│   ├── PushHistoryRepository.java
│   ├── PushGroupRepository.java
│   └── GroupMemberRepository.java
└── resources/
    ├── application.yml
    └── schema.sql
```

### 前端文件

```
push-frontend/src/
├── api/
│   ├── request.js
│   ├── push.js
│   ├── config.js
│   ├── history.js
│   └── group.js
├── components/
│   ├── PushDialog.vue
│   ├── PushHistoryDialog.vue
│   └── GroupConfigDialog.vue
├── App.vue
└── main.js
```
