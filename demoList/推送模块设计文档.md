# 推送功能模块设计文档

## 1. 项目概述

本项目实现一个可配置的多平台推送管理模块，支持对接不同平台的API进行推送，并提供配置化、历史记录和群组管理功能。

## 2. 技术栈

| 层级 | 技术选型 |
|------|---------|
| 前端 | Vue 3 + Element UI Plus + JavaScript |
| 后端 | Java 21 + Spring Boot 3.4.4 |
| 数据库 | MySQL 8.0+ |

## 3. 架构设计原则

- **简洁性**：避免过度设计，用最简单的方案满足需求
- **扩展性**：通过抽象接口支持新增推送平台
- **配置化**：核心参数通过配置管理，减少硬编码
- **可追溯**：所有推送操作留痕

## 4. 数据库设计

### 4.1 推送平台表 (`push_platform`)
存储支持的推送平台信息

```sql
CREATE TABLE push_platform (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    platform_code VARCHAR(50) NOT NULL UNIQUE COMMENT '平台编码：W3_TODO, WELINK_APP',
    platform_name VARCHAR(100) NOT NULL COMMENT '平台名称',
    api_endpoint VARCHAR(255) COMMENT 'API地址（可选，配置中覆盖）',
    enabled TINYINT DEFAULT 1 COMMENT '是否启用 0-禁用 1-启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推送平台表';
```

### 4.2 业务类型表 (`business_type`)
存储业务类型信息

```sql
CREATE TABLE business_type (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    business_code VARCHAR(50) NOT NULL UNIQUE COMMENT '业务编码：QA_REPORT, TEST_REPORT',
    business_name VARCHAR(100) NOT NULL COMMENT '业务名称',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='业务类型表';
```

### 4.3 推送配置表 (`push_config`)
业务类型与推送平台的配置关系

```sql
CREATE TABLE push_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    business_type_id BIGINT NOT NULL COMMENT '业务类型ID',
    platform_code VARCHAR(50) NOT NULL COMMENT '平台编码',
    enabled TINYINT DEFAULT 1 COMMENT '是否启用',
    config_json TEXT COMMENT '推送配置JSON（静态参数）',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_business_platform (business_type_id, platform_code),
    FOREIGN KEY (business_type_id) REFERENCES business_type(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推送配置表';
```

### 4.4 推送历史表 (`push_history`)
所有推送记录

```sql
CREATE TABLE push_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    business_type_id BIGINT NOT NULL COMMENT '业务类型ID',
    platform_code VARCHAR(50) NOT NULL COMMENT '平台编码',
    group_id BIGINT COMMENT '使用的群组ID',
    business_key VARCHAR(100) COMMENT '业务主键（如报告ID）',
    request_json TEXT NOT NULL COMMENT '完整请求参数',
    response_json TEXT COMMENT '响应结果',
    status TINYINT DEFAULT 0 COMMENT '状态 0-失败 1-成功',
    error_message TEXT COMMENT '错误信息',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_business_type (business_type_id),
    INDEX idx_platform (platform_code),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推送历史表';
```

### 4.5 推送群组表 (`push_group`)
推送群组信息

```sql
CREATE TABLE push_group (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    group_name VARCHAR(100) NOT NULL COMMENT '群组名称',
    description VARCHAR(255) COMMENT '群组描述',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推送群组表';
```

### 4.6 群组成员表 (`group_member`)
群组成员关系

```sql
CREATE TABLE group_member (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    group_id BIGINT NOT NULL COMMENT '群组ID',
    employee_no VARCHAR(50) NOT NULL COMMENT '工号',
    employee_name VARCHAR(100) COMMENT '姓名',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_group_employee (group_id, employee_no),
    FOREIGN KEY (group_id) REFERENCES push_group(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='群组成员表';
```

## 5. 后端设计

### 5.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                      Controller 层                        │
│  - PushConfigController                                   │
│  - PushHistoryController                                  │
│  - PushGroupController                                    │
│  - PushController (推送执行)                               │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                      Service 层                           │
│  - PushConfigService                                      │
│  - PushHistoryService                                     │
│  - PushGroupService                                       │
│  - PushService (推送编排)                                  │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                      推送适配器层                          │
│  - PushPlatformStrategy (接口)                            │
│  - W3TodoPushStrategy (W3代办实现-模拟)                    │
│  - WeLinkAppPushStrategy (WeLink应用号实现-模拟)               │
└─────────────────────────────────────────────────────────┘
```

### 5.2 核心接口设计

#### 5.2.1 推送配置接口

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/push/config/business/{businessCode} | 获取业务配置 |
| POST | /api/push/config | 保存/更新推送配置 |
| DELETE | /api/push/config/{id} | 删除配置 |
| GET | /api/push/config/business-types | 获取所有业务类型 |

#### 5.2.2 推送接口

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /api/push/preview | 预览推送内容 |
| POST | /api/push/execute | 执行推送 |

#### 5.2.3 历史记录接口

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/push/history/page | 分页查询历史记录 |
| GET | /api/push/history/{id} | 获取详情 |

#### 5.2.4 群组接口

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/push/groups | 获取群组列表 |
| POST | /api/push/groups | 创建群组 |
| PUT | /api/push/groups/{id} | 更新群组 |
| DELETE | /api/push/groups/{id} | 删除群组 |
| GET | /api/push/groups/{id}/members | 获取群组成员 |
| POST | /api/push/groups/{id}/members | 添加成员 |
| DELETE | /api/push/groups/{id}/members/{memberId} | 删除成员 |

### 5.3 推送策略接口

```java
public interface PushPlatformStrategy {
    /**
     * 构建推送参数
     */
    Map<String, Object> buildPushRequest(
        Map<String, Object> config,
        Map<String, Object> dynamicParams,
        List<GroupMember> groupMembers
    );

    /**
     * 执行推送（当前为模拟实现）
     */
    PushResult execute(Map<String, Object> request);

    /**
     * 获取平台编码
     */
    String getPlatformCode();
}
```

## 6. 前端设计

### 6.1 目录结构

```
src/
├── api/
│   ├── request.js       # Axios 封装
│   ├── push.js          # 推送相关API
│   ├── config.js        # 配置相关API
│   ├── history.js       # 历史记录API
│   └── group.js         # 群组相关API
├── components/
│   ├── PushDialog.vue   # 推送弹窗组件
│   ├── PushHistoryDialog.vue  # 历史记录弹窗
│   └── GroupConfigDialog.vue  # 群组配置弹窗
├── App.vue            # 主应用（包含演示页面）
└── main.js            # 应用入口
```

### 6.2 核心组件设计

#### 6.2.1 PushDialog.vue (推送弹窗)

**功能：**
- 显示业务类型和推送平台
- 展示每个平台的完整参数（区分来源：配置/动态）
- 选择群组
- 预览推送内容
- 二次确认后执行推送
- 跳转到历史记录和群组配置

**Props：**
- `visible`: Boolean - 是否显示
- `businessCode`: String - 业务编码
- `dynamicParams`: Object - 动态参数
- `businessKey`: String - 业务主键

#### 6.2.2 PushHistoryDialog.vue (历史记录弹窗)

**功能：**
- 表格展示历史推送记录
- 支持分页
- 显示业务、平台、状态、时间
- 可查看详情（请求参数和响应结果）

#### 6.2.3 GroupConfigDialog.vue (群组配置弹窗)

**功能：**
- 群组列表（增删改）
- 成员管理（添加/删除工号）
- 成员列表展示

## 7. Spring Boot 配置

```yaml
server:
  port: 8080

spring:
  application:
    name: push-system

  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/push_system?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&createDatabaseIfNotExist=true
    username: root
    password: chd19970227

  jpa:
    hibernate:
      ddl-auto: none
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        format_sql: true
```

## 8. 初始化数据

```sql
-- 初始化推送平台
INSERT INTO push_platform (platform_code, platform_name) VALUES
('W3_TODO', 'W3代办'),
('WELINK_APP', 'WeLink应用号');

-- 初始化业务类型
INSERT INTO business_type (business_code, business_name) VALUES
('QA_REPORT', 'QA报告'),
('TEST_REPORT', '测试报告');

-- 初始化推送配置示例
INSERT INTO push_config (business_type_id, platform_code, enabled, config_json) VALUES
(1, 'W3_TODO', 1, '{"type": "QA", "source": "QA系统"}'),
(2, 'W3_TODO', 1, '{"type": "Test", "source": "测试系统"}'),
(2, 'WELINK_APP', 1, '{"category": "test_report"}');

-- 初始化测试群组
INSERT INTO push_group (group_name, description) VALUES
('QA审核组', 'QA报告审核人员'),
('测试组', '测试相关人员');

-- 初始化群组成员
INSERT INTO group_member (group_id, employee_no, employee_name) VALUES
(1, 'c00807372', '张三'),
(1, 'c00807373', '李四'),
(2, 'c00807374', '王五'),
(2, 'c00807375', '赵六');
```

## 9. 运行说明

### 9.1 后端运行

```bash
cd push-backend
mvn clean spring-boot:run
```

后端服务将运行在 `http://localhost:8080`

### 9.2 前端运行

```bash
cd push-frontend
npm run dev
```

前端服务将运行在 `http://localhost:5173`

## 10. 推送实现说明

当前推送策略采用**模拟实现**，不实际调用外部 API：

- `W3TodoPushStrategy`: 模拟 W3 代办推送，打印请求参数到控制台
- `WeLinkAppPushStrategy`: 模拟 WeLink 应用号推送，打印请求参数到控制台

**后续集成真实 API：**

1. 在 `pom.xml` 添加 OpenFeign 依赖（如需要）
2. 创建 Feign Client 接口
3. 在策略实现中注入并调用
4. 删除模拟代码

示例代码已包含注释说明集成位置。

## 11. 文件清单

### 后端文件

```
push-backend/src/main/java/com/push/
├── PushApplication.java           # 启动类
├── controller/
│   ├── PushConfigController.java
│   ├── PushController.java
│   ├── PushHistoryController.java
│   └── PushGroupController.java
├── service/
│   ├── impl/
│   │   ├── PushConfigServiceImpl.java
│   │   ├── PushServiceImpl.java
│   │   ├── PushHistoryServiceImpl.java
│   │   └── PushGroupServiceImpl.java
│   ├── PushConfigService.java
│   ├── PushService.java
│   ├── PushHistoryService.java
│   └── PushGroupService.java
├── strategy/
│   ├── PushPlatformStrategy.java
│   ├── W3TodoPushStrategy.java
│   └── WeLinkAppPushStrategy.java
├── entity/
│   ├── PushPlatform.java
│   ├── BusinessType.java
│   ├── PushConfig.java
│   ├── PushHistory.java
│   ├── PushGroup.java
│   └── GroupMember.java
├── dto/
│   ├── PushPreviewRequest.java
│   ├── PushPreviewResponse.java
│   ├── PushExecuteRequest.java
│   ├── PushResult.java
│   └── ApiResponse.java
├── mapper/
│   ├── PushPlatformRepository.java
│   ├── BusinessTypeRepository.java
│   ├── PushConfigRepository.java
│   ├── PushHistoryRepository.java
│   ├── PushGroupRepository.java
│   └── GroupMemberRepository.java
└── resources/
    ├── application.yml
    └── schema.sql
```

### 前端文件

```
push-frontend/src/
├── api/
│   ├── request.js
│   ├── push.js
│   ├── config.js
│   ├── history.js
│   └── group.js
├── components/
│   ├── PushDialog.vue
│   ├── PushHistoryDialog.vue
│   └── GroupConfigDialog.vue
├── App.vue
└── main.js
```
